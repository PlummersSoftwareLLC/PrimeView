@page "/report"

@using BlazorTable
@using PrimeView.Entities
@using PrimeView.Frontend.Tools

<div class="row h-100">
	<div class="col">
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><a href="/">Reports</a></li>
				<li class="breadcrumb-item active" aria-current="page">@ReportTitle</li>
			</ol>
		</nav>

		<h1>@ReportTitle</h1>

		@if (report == null)
		{
			<div class="row">
				<div class="col-auto text-success">
					<div class="spinner-border"></div>
				</div>
				<div class="col text-left">
					Loading...
				</div>
			</div>
		}
		else
		{

			var cpu = report.CPU;
			var os = report.OperatingSystem;
			var system = report.System;
			var docker = report.DockerInfo;

			<div class="accordion">
				<div class="card">
					<div class="card-header">
						<h2 class="mb-0">
							<button class="btn btn-block text-primary text-left" type="button" @onclick="ToggleSystemInfoPanel">
								<i class="fa @(HideSystemInformation ? "fa-angle-right" : "fa-angle-down")"></i>&nbsp;&nbsp;System Information
							</button>
						</h2>
					</div>

					<div class="collapse@(HideSystemInformation ? "" : ".show")">
						<div class="row">
							<div class="col-2">
								<div class="list-group" id="list-tab" role="tablist">
									@if (cpu != null)
									{
										<a class="list-group-item list-group-item-action active" id="cpu-list" data-toggle="list" href="#cpu-info" role="tab" aria-controls="cpu">CPU</a>
									}
									@if (os != null)
									{
										<a class="list-group-item list-group-item-action" id="os-list" data-toggle="list" href="#os-info" role="tab" aria-controls="os">Operating System</a>
									}
									@if (system != null)
									{
										<a class="list-group-item list-group-item-action" id="system-list" data-toggle="list" href="#system-info" role="tab" aria-controls="system">System</a>
									}
									@if (docker != null)
									{
										<a class="list-group-item list-group-item-action" id="docker-list" data-toggle="list" href="#docker-info" role="tab" aria-controls="docker">Docker</a>
									}
								</div>
							</div>
							<div class="col">
								<div class="tab-content" id="nav-tabContent">
									@if (cpu != null)
									{
										<div class="tab-pane fade show active" id="cpu-info" role="tabpanel" aria-labelledby="cpu-list">
											<div class="row">
												<div class="col">
													<table class="table table-sm">
														<tbody>
															<ValueTableRow Label="Manufacturer" Value="cpu.Manufacturer" />
															<ValueTableRow Label="Brand" Value="cpu.Brand" />
															<ValueTableRow Label="Vendor" Value="cpu.Vendor" />
															<ValueTableRow Label="Family" Value="cpu.Family" />
															<ValueTableRow Label="Model" Value="cpu.Model" />
															<ValueTableRow Label="Stepping" Value="cpu.Stepping" />
															<ValueTableRow Label="Revision" Value="cpu.Revision" />
															<ValueTableRow Label="# Cores" Value="cpu.Cores" />
															<ValueTableRow Label="# Physical cores" Value="cpu.PhysicalCores" />
															<ValueTableRow Label="# Processors" Value="cpu.Processors" />
														</tbody>
													</table>
												</div>
												<div class="col">
													<table class="table table-sm">
														<tbody>
															<ValueTableRow Label="Speed" Value="cpu.Speed" />
															<ValueTableRow Label="Minimum speed" Value="cpu.MinimumSpeed" />
															<ValueTableRow Label="Maximum speed" Value="cpu.MaximumSpeed" />
															<ValueTableRow Label="Voltage" Value="cpu.Voltage" />
															<ValueTableRow Label="Governor" Value="cpu.Governor" />
															<ValueTableRow Label="Socket" Value="cpu.Socket" />
															@if (cpu.FlagValues != null)
															{
																<tr>
																	<th scope="row">Flags:</th>
																	<td>@string.Join(", ", cpu.FlagValues.OrderBy(f => f))</td>
																</tr>
															}
															<ValueTableRow Label="Virtualization" Value="cpu.Virtualization" />
															@if (cpu.Cache != null && cpu.Cache.Count > 0)
															{
																<tr>
																	<th scope="row">Cache:</th>
																	<td>
																		<table class="table table-sm table-borderless">
																			<tbody>
																				@foreach (var cacheLine in cpu.Cache)
																				{
																					<tr>
																						<th scope="row">@(cacheLine.Key):</th>
																						<rd>@cacheLine.Value</rd>
																					</tr>
																				}
																			</tbody>
																		</table>
																	</td>
																</tr>
															}
														</tbody>
													</table>
												</div>
											</div>
										</div>
									}
									@if (os != null)
									{
										<div class="tab-pane fade" id="os-info" role="tabpanel" aria-labelledby="os-list">
											<div class="row">
												<div class="col">
													<table class="table table-sm">
														<tbody>
															<ValueTableRow Label="Platform" Value="@os.Platform" />
															<ValueTableRow Label="Distribution" Value="@os.Distribution" />
															<ValueTableRow Label="Release" Value="@os.Release" />
															<ValueTableRow Label="Code name" Value="@os.CodeName" />
															<ValueTableRow Label="Kernel" Value="@os.Kernel" />
															<ValueTableRow Label="Architecture" Value="@os.Architecture" />
														</tbody>
													</table>
												</div>
												<div class="col">
													<table class="table table-sm">
														<tbody>
															<ValueTableRow Label="Code page" Value="@os.CodePage" />
															<ValueTableRow Label="Logo file" Value="@os.LogoFile" />
															<ValueTableRow Label="Build" Value="@os.Build" />
															<ValueTableRow Label="Serive pack" Value="@os.ServicePack" />
															<ValueTableRow Label="UEFI" Value="@os.IsUefi" />
														</tbody>
													</table>
												</div>
											</div>
										</div>
									}
									@if (system != null)
									{
										<div class="tab-pane fade" id="system-info" role="tabpanel" aria-labelledby="system-list">
											<div class="row">
												<div class="col">
													<table class="table table-sm">
														<tbody>
															<ValueTableRow Label="Manufacturer" Value="@system.Manufacturer" />
															<ValueTableRow Label="SKU" Value="@system.SKU" />
															<ValueTableRow Label="Virtual" Value="@system.IsVirtual" />
														</tbody>
													</table>
												</div>
												<div class="col">
													<table class="table table-sm">
														<tbody>
															<ValueTableRow Label="Model" Value="@system.Model" />
															<ValueTableRow Label="Version" Value="@system.Version" />
														</tbody>
													</table>
												</div>
											</div>
										</div>
									}
									@if (docker != null)
									{
										<div class="tab-pane fade" id="docker-info" role="tabpanel" aria-labelledby="docker-list">
											<div class="row">
												<div class="col">
													<table class="table table-sm">
														<tbody>
															<ValueTableRow Label="Kernel version" Value="@docker.KernelVersion" />
															<ValueTableRow Label="Operating system" Value="@docker.OperatingSystem" />
															<ValueTableRow Label="OS version" Value="@docker.OSVersion" />
															<ValueTableRow Label="OS type" Value="@docker.OSType" />
														</tbody>
													</table>
												</div>
												<div class="col">
													<table class="table table-sm">
														<tbody>
															<ValueTableRow Label="Architecture" Value="@docker.Architecture" />
															<ValueTableRow Label="# CPUs" Value="@docker.CPUCount" />
															<ValueTableRow Label="Total memory" Value="@docker.TotalMemory" />
															<ValueTableRow Label="Server version" Value="@docker.ServerVersion" />
														</tbody>
													</table>
												</div>
											</div>
										</div>
									}
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="card">
					<div class="card-header">
						<h2 class="mb-0">
							<button class="btn btn-block text-primary text-left" type="button" @onclick="ToggleFilterPanel">
								<i class="fa @(HideFilters ? "fa-angle-right" : "fa-angle-down")"></i>&nbsp;&nbsp;Filters
							</button>
						</h2>
					</div>

					<div class="collapse @(HideFilters ? "" : "show")">
						<form>
							<div class="row m-2 no-gutters">
								<div class="col-auto mt-2 ml-3 mr-1">
									<label for="implementatios">Language:</label>
								</div>
								<div class="col-auto mt-1 ml-1 mr-3">
									<select multiple class="form-control" id="implementations" @bind="fi">
										@foreach (var languageInfo in report.Results.Select(r => GetLanguageInfo(r.Implementation)).Distinct(new LanguageInfo.KeyEqualityComparer()).OrderBy(n => n.Name))
										{
											<option value="@languageInfo.Key">@languageInfo.Name</option>
										}
									</select>
								</div>
								<div class="col-auto mt-2 ml-3 mr-1">
									<label>Parallelism:</label>
								</div>
								<div class="col-auto mt-2 ml-1 mr-3">
									<div class="form-check">
										<input class="form-check-input" type="checkbox" id="fp_st" @bind="fp_st">
										<label class="form-check-label" for="fp_st">
											Single-threaded
										</label>
									</div>
									<div class="form-check">
										<input class="form-check-input" type="checkbox" id="fp-mt" @bind="fp_mt">
										<label class="form-check-label" for="fp_mt">
											Multithreaded
										</label>
									</div>
								</div>
								<div class="col-auto mt-2 ml-3 mr-1">
									<label>Algorithm:</label>
								</div>
								<div class="col-auto mt-2 ml-1 mr-3">
									<div class="form-check">
										<input class="form-check-input" type="checkbox" id="fa_ba" @bind="fa_ba">
										<label class="form-check-label" for="fa_ba">
											base
										</label>
									</div>
									<div class="form-check">
										<input class="form-check-input" type="checkbox" id="fa_wh" @bind="fa_wh">
										<label class="form-check-label" for="fa_wh">
											wheel
										</label>
									</div>
									<div class="form-check">
										<input class="form-check-input" type="checkbox" id="fa_ot" @bind="fa_ot">
										<label class="form-check-label" for="fa_ot">
											&lt;other&gt;
										</label>
									</div>
								</div>
								<div class="col-auto mt-2 ml-3 mr-1">
									<label>Bits per prime:</label>
								</div>
								<div class="col-auto mt-2 ml-1 mr-3">
									<div class="form-check">
										<input class="form-check-input" type="checkbox" id="fb_uk" @bind="fb_uk">
										<label class="form-check-label" for="fb_uk">
											<em>Unknown</em>
										</label>
									</div>
									<div class="form-check">
										<input class="form-check-input" type="checkbox" id="fb_on" @bind="fb_on">
										<label class="form-check-label" for="fb_on">
											wheel
										</label>
									</div>
									<div class="form-check">
										<input class="form-check-input" type="checkbox" id="fb_ot" @bind="fb_ot">
										<label class="form-check-label" for="fb_ot">
											&lt;other&gt;
										</label>
									</div>
								</div>
							</div>
							<div class="row m-2 no-gutters">
								<div class="col mt-2 mx-3">
									<button type="submit" class="btn btn-primary mb-2">Apply</button>
								</div>
							</div>
						</form>
					</div>
				</div>
			</div>

			<br />
			<Table TableItem="Result" Items="report.Results" PageSize="0" ColumnReorder="false" ShowFooter="true" @ref="resultTable" @onclick="() => processTableSortingChange = true">
				@{ OnTableRefreshStart(); }
				<Column TableItem="Result" Title="#" Sortable="false" Filterable="false" SetFooterValue="@($"{report.Results.Length}")">
					<Template>
						@(++rowNumber)
					</Template>
				</Column>
				<Column TableItem="Result" Title="Language" Field="@(r => r.Implementation)" Sortable="true" Filterable="true" SetFooterValue="@($"{report.Results.Select(r => r.Implementation).Distinct().Count()} languages")">
					<CustomIFilters>
						<CustomSelect TableItem="Result">
							@foreach (var languageInfo in report.Results.Select(r => GetLanguageInfo(r.Implementation)).Distinct(new LanguageInfo.KeyEqualityComparer()).OrderBy(n => n.Name))
							{
								<CustomSelectOption Key="@languageInfo.Name" Value="@languageInfo.Key" />
							}
						</CustomSelect>
					</CustomIFilters>
					<Template>
						@{var languageInfo = GetLanguageInfo(context.Implementation);}
						@if (languageInfo.URL != null)
						{
							<a href="@languageInfo.URL" target="_blank" rel="noreferrer noopener">@languageInfo.Name</a>
						}
						else
						{
							@languageInfo.Name
						}
					</Template>
				</Column>
				<Column TableItem="Result" Title="Solution" Field="@(r => r.Solution)" Sortable="false" Filterable="false" />
				<Column TableItem="Result" Title="Label" Field="@(r => r.Label)" Sortable="true" Filterable="true" />
				<Column TableItem="Result" Title="Passes" Field="@(r => r.Passes)" Sortable="true" Filterable="true" />
				<Column TableItem="Result" Title="Duration" Field="@(r => r.Duration)" Sortable="true" Filterable="true" />
				<Column TableItem="Result" Title="# Threads" Field="@(r => r.Threads)" Sortable="true" Filterable="true" SetFooterValue="@($"{report.Results.Count(r => !r.IsMultiThreaded)} single-threaded")" />
				<Column TableItem="Result" Title="Passes/s/t" Field="@(r => r.PassesPerSecond)" Sortable="true" Filterable="true" />
				<Column TableItem="Result" Title="Multithreaded" Field="@(r => r.IsMultiThreaded)" Sortable="true" Filterable="true" SetFooterValue="@($"{report.Results.Count(r => r.IsMultiThreaded)} multithreaded")">
					<CustomIFilters>
						<CustomSelect TableItem="Result">
							<CustomSelectOption Key="yes" Value="@("True")" />
							<CustomSelectOption Key="no" Value="@("False")" />
						</CustomSelect>
					</CustomIFilters>
					<Template>
						<span class="text-success">@(context.IsMultiThreaded ? "yes" : "no")</span>
					</Template>
				</Column>
				<Column TableItem="Result" Title="Algorithm" Field="@(r => r.Algorithm)" Sortable="true" Filterable="true" SetFooterValue="@($"{report.Results.Count(r => r.Algorithm == "base")} base")">
					<CustomIFilters>
						<CustomSelect TableItem="Result">
							@foreach (var algorithm in report.Results.Select(r => r.Algorithm).Where(a => a != null).Distinct().OrderBy(a => a))
							{
								<CustomSelectOption Key="@algorithm" Value="@algorithm" />
							}
						</CustomSelect>
					</CustomIFilters>
					<Template>
						@if (context.Algorithm == "base")
						{
							<span class="text-success">@context.Algorithm</span>
						}
						else
						{
							@context.Algorithm
						}
					</Template>
				</Column>
				<Column TableItem="Result" Title="Faithful" Field="@(r => r.IsFaithful)" Sortable="true" Filterable="true" SetFooterValue="@($"{report.Results.Count(r => r.IsFaithful == true)} faithful")">
					<CustomIFilters>
						<CustomSelect TableItem="Result">
							<CustomSelectOption Key="yes" Value="@("True")" />
							<CustomSelectOption Key="no" Value="@("False")" />
						</CustomSelect>
					</CustomIFilters>
					<Template>
						@if (context.IsFaithful == true)
						{
							<span class="text-success">yes</span>
						}
						else
						{
							<span>no</span>
						}
					</Template>
				</Column>
				<Column TableItem="Result" Title="Bits" Field="@(r => r.Bits)" Sortable="true" Filterable="true" SetFooterValue="@($"{report.Results.Count(r => r.Bits == 1)} single-bit")">
					<CustomIFilters>
						<CustomSelect TableItem="Result">
							@foreach (var bitCount in report.Results.Select(r => r.Bits).Where(b => b != null).Cast<int>().Distinct().OrderBy(b => b))
							{
								<CustomSelectOption Key="@bitCount.ToString()" Value="@bitCount" />
							}
						</CustomSelect>
					</CustomIFilters>
					<Template>
						@if (context.Bits == 1)
						{
							<span class="text-success">@context.Bits</span>
						}
						else if (context.Bits == null)
						{
							<em>Unknown</em>
						}
						else
						{
							@context.Bits
						}
					</Template>
				</Column>
			</Table>
		}
	</div>
</div>
